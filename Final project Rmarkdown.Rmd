---
title: "Final project"
author: "Adriele Benedetto"
date: "18/01/2021"
output: html_document
---

knitr::opts_chunk$set(echo = FALSE)
#install.packages("readxl")
#install.packages("igraph")
# install.packages("gridExtra")

Note that the data was provided by the following scientific article: *“Pest control of aphids on landscape complexity and natural enemy interactions”.* 
It can be retrieved from: https://datadryad.org/stash/dataset/doi:10.5061/dryad.n6428

# Introduction

Aphids are a *major concern* in agricultural crops. Control by natural enemies is an essential component of the ecological intensification of agriculture. 
This study used multiple natural enemy enclosures replicated in 18 fields of Brassica oleracea and other crop types across a gradient in *landscape complexity* to investigate:the strength of natural pest control across landscapes, the contribution of natural enemy guilds to pest control and the interaction effect between natural enemy guilds and landscape. 

In this study, the variables are as follows:

*Dependent variables*
1. Aphid Population Growth (APG) 
2. Aphid density 
3. Parasitized Aphids 
4. Parasitism rate (PR)
5. Syrphid larvae
6. Syrphid fraction and the real final dependent variable which is  7. Final cabbage biomass

*Independent variables*
1. Landscape complexity (% semi-natural habitat at a radius around fields)
2. Treatments (different combinations of Natural Enemies exclusions) 3. Field management (organic versus conventional),
4. Sampling Date
5. Crop Type
6. Crop Maturity 
7. Plot 

We used 6 of the dependent variableS to assess the best relationship with the independent variables. We also tested the interactions between 2 or more dependent variables e.g APG and PR

We have represented all possible relationships in the following *network*

library(readxl)
library(igraph)
links <- read_excel("Relationships between variables.xlsx")
network <- graph_from_data_frame(d = links, directed = T) 
plot(network, vertex.color = "yellow", edge.arrow.size = 1, vertex.label.font = 2, vertex.label.color = "black")

# Team Objectives
To determine:
The effect of natural enemies (NE) on APG across a gradient of Landscape Complexity (LC).

The effect of NE on parasitism rate and syrphid fraction across a gradient of LC.

The possible interaction between NE and LC. Interaction would imply that the effects of NE guilds are affected by the complexity of the landscape.  


# Research Questions and Hypotheses.

1. Does the presence of natural enemies (NE) decrease aphid population growth? 

2. Is the effect of NE complementary or antagonist on the dependent variables (e.g. APG, parasitism rate, syrphid fraction)?

3. Is there a difference in the effect of NE over aphids between complex and simple landscapes?

4. Is there an interaction between the efficiency of NE and landscape complexity (LC)?

5. Do parasitism and syrphid presence increase with greater landscape complexity?

6. Does aphid population growth decrease cabbage biomass?


# Methodology using R and Excel

Step by Step:

1. We calculated 3 new variables whose formulas were given: APG, parasitism rate and syrphid fraction. 

2. We created an excel sheet listing all the relationships between the variables that are relevant to assess. 

3. We plotted the major relationships to outline trends and study the relationships between key variables.

4. We ran a significant amount of linear models (lm) to know what model fits best for 6 dependent variables (only 3 in the original study): Aphids density, APG, aphids parasitized, parasitism rate, syrphid fraction and biomass. 

5. We carried out ANOVAS followed by “post hoc” tests to highlight significant differences between the models. 

# Results

####import data and make data frame called "DataOG" includes APhids population growth, parasitism rate and syrphid fraction.
```{r}
# creation of DataOG with all variables

Data1 <- read.table("Project data.csv", header = TRUE, dec = ",", sep = ";")
Data1$APG <- NA 
A <- Data1$Date == "1"
Data1[A, "APG"] <- ((log(Data1$aphid_live[A] + 1) - log(Data1$aphidsinoculated_init[A] + 1))/10)
A <- Data1$Date == "2"
Data1[A, "APG"] <- ((log(Data1$aphid_live[A] + 1) - log(Data1$aphidsinoculated_init[A] + 1))/20)
A <- Data1$Date == "3"
Data1[A, "APG"] <- ((log(Data1$aphid_live[A] + 1) - log(Data1$aphidsinoculated_init[A] + 1))/30)
DataOG <- Data1

parasitism_rate <- (Data1$aphid_parasitized/(Data1$aphid_live + Data1$aphid_parasitized))
DataOG$parasitism_rate <- parasitism_rate

syrphid_fraction <- (Data1$syrphidl_p / ((Data1$aphid_live) + (Data1$syrphidl_p)))
DataOG$syrphid_fraction <- syrphid_fraction


#convert NaN to 0
is.nan.data.frame <- function(x)
  do.call(cbind, lapply(x, is.nan))
DataOG[is.nan(DataOG)] <- 0

#convert inf to 1
is.infinite.data.frame <- function(y)
  do.call(cbind, lapply(y, is.infinite))
DataOG[is.infinite(DataOG)] <- 1

```

#### *Effects of landscape complexity and natural enemy exclusion on average daily aphid population growth across three sampling dates (1-3)*


```{r}
#choose only the
A <- DataOG$BUFF_DIST == "700"
Data700 <- DataOG[A,]                       

# plot APG ~ % of seminatural habitat for each treatment
library(ggplot2)
ggplot(Data700, aes(x = Pt.seminatural, y = APG, color = Treatment, alpha = "0")) +
labs(x = "Landscape complexity (% of seminatural habitat)", y = "APG",
title = "Effects of landscape complexity on APG in each treatment at 3 different dates") +
geom_smooth(method = "lm") +
facet_grid(.~Date)
```



##### *Comments:*

APG slope flattens, gets less steep over time. 
In all treatments and for all dates (except the last one when it is less clear), we see a trend highlighting an increase in APG as landscape complexity increases. 
In treatments involving more than 2 natural enemies, APG growth was the lowest. Examples are O, HPGD, HBP.
When all natural enemies are excluded (H treatment), APG growth is at its highest.
This finding is consistent with our hypothesis. 



### Effects of enemy exclusion treatments (combination of NE guilds) on APG at Date 1, 2 and 3


```{r}
# new data frame with BUFF = 700
A <- DataOG$BUFF_DIST == "700"
Data700 <- Data1[A,] 
```

#####ANOVA and Tukey HSD (post hoc) test
```{r}
#creation of data frame DATE1_700
DATE1_700 <- Data700[Data700$Date == "1",]

```


```{r, include= FALSE}
#D1 anova test
anovaD1_APG <- aov(DATE1_700$APG ~ DATE1_700$Treatment, data = DATE1_700)
summary(anovaD1_APG)

TukeyHSD(anovaD1_APG)

library("agricolae")
HSD_D1_APG <- HSD.test(anovaD1_APG, "DATE1_700$Treatment", unbalanced = TRUE, group = T)
HSD_D1_APG
```

```{r, include= FALSE}
DATE2_700 <- Data700[Data700$Date == "2",]

#D2 anova test
anovaD2_APG <- aov(DATE2_700$APG ~ DATE2_700$Treatment, data = DATE2_700)
summary(anovaD2_APG)

TukeyHSD(anovaD2_APG)

library("agricolae")
HSD_D2_APG <- HSD.test(anovaD2_APG, "DATE2_700$Treatment", unbalanced = TRUE, group = T)
HSD_D2_APG
```

```{r, include= FALSE}
DATE3_700 <- Data700[Data700$Date == "3",]

#D3 anova test
anovaD3_APG <- aov(DATE3_700$APG ~ DATE3_700$Treatment, data = DATE3_700)
summary(anovaD3_APG)

TukeyHSD(anovaD3_APG)

library("agricolae")
HSD_D3_APG <- HSD.test(anovaD3_APG, "DATE3_700$Treatment", unbalanced = TRUE, group = T)
HSD_D3_APG

```


```{r}
#Put result of retter test into a vector called annos
annos = c('a','bc','ab','abc','c','c',
'a','b','b','b','b','b',
'a','bc','b','bc','c','bc')

```


```{r}
#plot
library(ggplot2)
ggplot(Data700, aes(x = Treatment, y = APG, fill = Treatment)) +
geom_boxplot() +
labs(x = "Enemy exclution treatment", y = "Aphids population growth",
title = "Effects of Treatment on APG at Different dates") +
geom_hline(yintercept = 0, colour = "grey") +
stat_summary(geom = 'text', label = annos, fun.y = max, vjust = -1) + facet_grid(.~Date) # same date but one factor changes (e.g. date)

```

*Comments:* 
Here we looked at the sole effect of natural enemies (different combinations) on aphid population growth, without considering landscape complexity. 
We ran anova tests and post-hoc analysis using the tukey test and the letter test which gave rise to the diagram you see. 
The same conclusions from the previous graph can be drawn here:
the treatments with either all natural enemies (O) or many of them (HPGD) had the strongest pest control effect. 
APG goes down considerably as time goes by. 
across all dates, ground dwellers had the smallest control effect out of all natural enemies. 

####  *Effect of enemy exclusion treatments on parasitism rate at Date 1, 2 and 3* 

# parasitism rate 

```{r}
# new data frame with BUFF = 200
A <- DataOG$BUFF_DIST == "200"
Data200 <- DataOG[A,] 
```

```{r, include= FALSE}

DATE1_200 <- Data200[Data200$Date == "1", ]

#D1 anova test
anovaD1_PR <- aov(DATE1_200$parasitism_rate ~ DATE1_200$Treatment, data = DATE1_200)
summary(anovaD1_PR)

TukeyHSD(anovaD1_PR)

library("agricolae")
HSD_D1_PR <- HSD.test(anovaD1_PR, "DATE1_200$Treatment", unbalanced = TRUE, group = T)
HSD_D1_PR
```

```{r, include= FALSE}
DATE2_200 <- Data200[Data200$Date == "2", ]

#D1 anova test
anovaD2_PR <- aov(DATE2_200$parasitism_rate ~ DATE2_200$Treatment, data = DATE2_200)
summary(anovaD2_PR)

TukeyHSD(anovaD2_PR)

library("agricolae")
HSD_D2_PR <- HSD.test(anovaD2_PR, "DATE2_200$Treatment", unbalanced = TRUE, group = T)
HSD_D2_PR

```


```{r, include= FALSE}
DATE3_200 <- Data200[Data200$Date == "3", ]

#D1 anova test
anovaD3_PR <- aov(DATE3_200$parasitism_rate ~ DATE3_200$Treatment, data = DATE3_200)
summary(anovaD3_PR)

TukeyHSD(anovaD3_PR)

library("agricolae")
HSD_D3_PR <- HSD.test(anovaD3_PR, "DATE3_200$Treatment", unbalanced = TRUE, group = T)
HSD_D3_PR
```

```{r}
#ANOVA result for parasitism rate ~ treatment
annosPR = c('b','ab','b','ab','a','ab',
'c','b','bc','a','bc','bc',
'c','ab','bc','a','bc','bc')
```


```{r}
library(ggplot2)
ggplot(Data1, aes(x = Treatment, y = parasitism_rate, fill = Treatment)) +
geom_boxplot() +
labs(x = "Enemy exclution treatment", y = "Parasitism rate",
title = "Effects of Treatment on Parasitism rate at different dates") +
geom_hline(yintercept = 0, colour = "grey") +
stat_summary(geom = 'text', label = annosPR, fun.y = mean, vjust = -1) + facet_grid(.~Date)
```


##Remar:

This bar plot graph describes the relationship between the natural enemies treatment and parasitism rate. 
From this graph, we can notice that: 
the parasitism rate tend to increase over time in most treatments except for H and HGD. Both these treatments remain low for all dates considered.  In HPGC, parasitism rate is first very high and then drops at Date 2 (could be due to sampling mistakes here, given how parasitism rate rises back on Date 3). 
Globally, the more natural enemies are involved, the higher the parasitism rate of aphids. Look at treatment O, HPGD, HBP. 

### *Effect of enemy exclusion treatments on syrphid fraction at Date 1, 2 and 3*

```{r}
# new data frame with BUFF = 900

A <- DataOG$BUFF_DIST == "900"
Data900 <- DataOG[A,]   
```

```{r, include= FALSE}
#ANOVA for syrphid fraction at date 1
DATE1_900 <- Data900[Data900$Date == "1",]

#D1 anova test
anovaD1_SF <- aov(DATE1_900$syrphid_fraction ~ DATE1_900$Treatment, data = DATE1_900)

summary(anovaD1_SF)

TukeyHSD(anovaD1_SF)

library("agricolae")
HSD_D1_SF <- HSD.test(anovaD1_SF, "DATE1_900$Treatment", unbalanced = TRUE, group = T)
HSD_D1_SF
```

```{r, include= FALSE}
#ANOVA for syrphid fraction at date 2
DATE2_900 <- Data900[Data900$Date == "2",]

#D2 anova test
anovaD2_SF <- aov(DATE2_900$syrphid_fraction ~ DATE2_900$Treatment, data = DATE2_900)
summary(anovaD2_SF)

TukeyHSD(anovaD2_SF)

library("agricolae")
HSD_D2_SF <- HSD.test(anovaD2_SF, "DATE2_900$Treatment", unbalanced = TRUE, group = T)
HSD_D2_SF

```


```{r, include= FALSE}
DATE3_900 <- Data900[Data900$Date == "3",]

#D3 anova test
anovaD3_SF <- aov(DATE3_900$syrphid_fraction ~ DATE3_900$Treatment, data = DATE3_900)

summary(anovaD3_SF)

TukeyHSD(anovaD3_SF)

library("agricolae")
HSD_D3_SF <- HSD.test(anovaD3_SF, "DATE3_900$Treatment", unbalanced = TRUE, group = T)
HSD_D3_SF

```


```{r}
#ANOVA result for syrphid fraction ~ treatment
annosSF = c('b','b','b','ab','ab','a',
            'b','ab','ab','a','ab','ab',
            'a','a','a','a','a','a')

```


```{r}
# plot

A <- DataOG$BUFF_DIST == "900"
Data900 <-DataOG[A,] 

library(ggplot2)
ggplot(Data900, aes(x = Treatment, y = syrphid_fraction , fill = Treatment)) +
geom_boxplot() +
labs(x = "Enemy exclution treatment", y = "Syrphid fraction",
title = "Effects of Treatment on syrphid fraction at different dates") +
geom_hline(yintercept = 0, colour = "grey") +
  stat_summary(geom = 'text', label =annosSF, fun.y = mean , vjust = -1)+
facet_grid(.~Date)

```

###comments date3 syrphid fraction anova



##Remarks 

Similar findings of the graph from the previous result can be observed;
-An increase in syrphid fraction over time in most treatments except for HGD and H. Syrphid fraction in HPGD grows also quite slow. 
Treatments involving a large combination of NE show a higher syrphid fraction: O, HPGD, HBP. 
Note that NaN have been purposely removed to obtain this graph. Given that syrphid fraction is a division, many values had NaN because of the division by 0.




```{r, include= FALSE}
#####parasitism_rate ~ Pt.seminatural
library(ggplot2)
A <- DataOG$BUFF_DIST == "200"
Data200 <-DataOG[A,]   

G1 <- ggplot(Data200, aes(Pt.seminatural, parasitism_rate)) + 
  labs(x = "% seminatural habitat", y = "Parasitism rate", title = " Effect of landscape complexity on PR")+
   geom_point() +
  geom_smooth(method = "lm") 
G1

###syrphid_fraction ~ Pt.seminatural)

B <- DataOG$BUFF_DIST == "900"
Data900 <-DataOG[B,]   

G2 <- ggplot(Data900, aes(Pt.seminatural, syrphid_fraction)) + 
 labs(x = "% seminatural habitat", y = "Syrphid fraction", title = " Effect of landscape complexity on SF")+
  geom_point() +
  geom_smooth(method = "lm")
G2
```


```{r}
# install.packages("gridExtra")
library(gridExtra)
grid.arrange(G1, G2, nrow = 1)

```



```{r}
# combine the scatter plots into 1 graph

attach(DataOG)
par(mfrow=c(3,1))
plot(APG ~ parasitism_rate, data = DataOG, xlab="Parasitism rate", main = "Effect of parasitism rate on APG across all dates")
abline(lm(APG ~ parasitism_rate, data = DataOG))
plot(APG ~ syrphid_fraction, data = DataOG, xlab ="Syrphid fraction", main = "Effect of syrphid fraction on APG across all dates")
abline(lm(APG ~ syrphid_fraction, data = DataOG))
plot(Biomass_fin ~ syrphid_fraction, data = DataOG, xlab ="Syrphid fraction", ylab = "Final Cabbage Biomass (g)", main = "Effect of syrphid fraction on final cabbage biomass")
abline(lm(Biomass_fin ~ syrphid_fraction, data = DataOG))
```




